import * as $rjs_core from '../../../../runtime/core.js';import * as M0 from "../../../../runtime/kernel.rkt.js";import * as M1 from "../private/jscommon.rkt.js";import * as M2 from "../../../racketscript-compiler/racketscript/interop.rkt.js";var _times_default_frames_per_second_times_ = 70;var make_big_bang = function(init_world744, handlers745) {return new BigBang(init_world744,handlers745);};var big_bang = function() {var init_world746 = arguments[0];var handlers747 = $rjs_core.Pair.listFromArray($rjs_core.argumentsSlice($rjs_core.argumentsToArray(arguments),1));return make_big_bang(init_world746,handlers747).setup().start();};var BigBang = function(init_world748, handlers749) {this.world = init_world748;this.interval = 1000/_times_default_frames_per_second_times_;this.handlers = handlers749;this._active_handlers = {};this._world_change_listeners = [];this._idle = true;this._stopped = true;this._events = [];return null;};BigBang.prototype.setup = function() {var canvas750 = M1.document.createElement("canvas");var ctx751 = canvas750.getContext("2d");canvas750.setAttribute("tabindex",1);var let_result1000 = M0.values();this._canvas = canvas750;var let_result1001 = M0.values();this._context = ctx751;var let_result1002 = M0.values();M1.document.body.appendChild(canvas750);var let_result1003 = M0.values();canvas750.focus();var let_result1004 = M0.values();this.register_handlers();var let_result1005 = M0.values();var draw_handler752 = this._active_handlers["to-draw"];if (draw_handler752) {var if_res1006 = M0.rvoid();} else {var if_res1006 = M0.error($rjs_core.Symbol.make("big-bang"),"to-draw handle not provided");}if_res1006;var let_result1007 = M0.values();var img753 = draw_handler752.callback(this.world);canvas750.width = img753.width;canvas750.height = img753.height;this.change_world(this.world);return this;};BigBang.prototype.register_handlers = function() {var active_handlers754 = this._active_handlers;var self755 = this;var loop756 = function(handlers757) {if (M0.pair_p(handlers757)) {var h758 = M0.car(handlers757)(self755);h758.register();active_handlers754[h758.name] = h758;var if_res1008 = loop756(M0.cdr(handlers757));} else {var if_res1008 = M0.rvoid();}return if_res1008;};return loop756(this.handlers);};BigBang.prototype.deregister_handlers = function() {var active_handlers759 = this._active_handlers;var self760 = this;return Object.keys(active_handlers759).forEach(function(key761) {var h762 = active_handlers759[key761];h762.deregister();active_handlers759[h762.name] = undefined;return null;});};BigBang.prototype.start = function() {this._stopped = false;return this.process_events();};BigBang.prototype.stop = function() {this.clear_event_queue();this._stopped = true;this._idle = true;this.deregister_handlers();this._active_handlers = {};this.handlers = $rjs_core.Pair.Empty;return null;};BigBang.prototype.clear_event_queue = function() {return this._events.splice(0,this._events.length);};BigBang.prototype.queue_event = function(e763) {this._events.push(e763);if (this._idle) {var self764 = this;var if_res1009 = window.requestAnimationFrame(function() {return self764.process_events();});} else {var if_res1009 = M0.rvoid();}return if_res1009;};BigBang.prototype.change_world = function(new_world765) {var listeners766 = this._world_change_listeners;var loop767 = function(i768) {if (M0._lt_(i768,listeners766.length)) {var listener769 = listeners766[i768];listener769(new_world765);var if_res1010 = loop767(M0.add1(i768));} else {var if_res1010 = M0.rvoid();}return if_res1010;};loop767(0);this.world = new_world765;return null;};BigBang.prototype.add_world_change_listener = function(cb770) {return this._world_change_listeners.push(cb770);};BigBang.prototype.remove_world_change_listener = function(cb771) {var index772 = this._world_change_listeners.indexOf(cb771);return this._world_change_listeners.splice(index772,1);};BigBang.prototype.process_events = function() {var events773 = this._events;var self774 = this;this._idle = false;var loop775 = function(world_changed_p776) {if (M0._gt_(events773.length,0)) {var evt777 = events773.shift();var handler778 = self774._active_handlers[evt777.type];if (handler778) {var if_res1012 = handler778.invoke(self774.world,evt777);} else {if (M0.equal_p(evt777.type,"raw")) {var if_res1011 = evt777.invoke(self774.world,evt777);} else {var if_res1011 = M1.console.warn("ignoring unknown/unregistered event type: ",evt777);}var if_res1012 = if_res1011;}var changed_p779 = if_res1012;var or_part780 = world_changed_p776;if (or_part780) {var if_res1013 = or_part780;} else {var if_res1013 = changed_p779;}var if_res1016 = loop775(if_res1013);} else {if (world_changed_p776) {var if_res1014 = M0.not(self774._stopped);} else {var if_res1014 = false;}if (if_res1014) {self774.queue_event({'type':"to-draw"});var if_res1015 = loop775(false);} else {var if_res1015 = M0.rvoid();}var if_res1016 = if_res1015;}return if_res1016;};loop775(false);this._idle = true;return null;};var to_draw = function(cb781) {return function(bb782) {var on_tick_evt783 = {'type':"to-draw"};return {'name':"to-draw",'register':function() {return M0.rvoid();},'deregister':function() {return M0.rvoid();},'callback':cb781,'invoke':function(world784, evt785) {var ctx786 = bb782._context;var img787 = cb781(bb782.world);var height788 = img787.height;var width789 = img787.width;ctx786.clearRect(0,0,width789,height788);img787.render(ctx786,width789/2,height788/2);return false;}};};};var on_tick = function(cb790, rate791) {return function(bb792) {var on_tick_evt793 = {'type':"on-tick"};return {'name':"on-tick",'register':function() {bb792.queue_event(on_tick_evt793);if (rate791) {rate791 = 1000*rate791;var if_res1017 = null;} else {rate791 = bb792.interval;var if_res1017 = null;}return if_res1017;},'deregister':function() {var last_cb794 = this.last_cb;if (last_cb794) {var if_res1018 = window.clearTimeout(last_cb794);} else {var if_res1018 = M0.rvoid();}return if_res1018;},'invoke':function(world795, _796) {bb792.change_world(cb790(world795));this.last_cb = setTimeout(function() {return bb792.queue_event(on_tick_evt793);},rate791);return true;}};};};var on_mouse = function(cb797) {return function(bb798) {return {'name':"on-mouse",'listeners':{},'register':function() {var canvas799 = bb798._canvas;var make_listener800 = function(r_evt_name801) {return function(evt802) {var posn803 = canvas_posn_δ(canvas799,evt802);return bb798.queue_event({'type':"on-mouse",'evt':r_evt_name801,'x':posn803.x,'y':posn803.y});};};var self804 = this;var register_listener805 = function(evt_name806, r_evt_name807) {var cb808 = make_listener800(r_evt_name807);canvas799.addEventListener(evt_name806,cb808);self804.listeners[evt_name806] = cb808;return null;};register_listener805("mousemove","move");register_listener805("mousedown","button-down");register_listener805("mouseup","button-up");register_listener805("mouseout","leave");register_listener805("mouseover","enter");return register_listener805("drag","drag");},'deregister':function() {var self809 = this;var remove_listener810 = function(evt_name811) {var cb812 = self809.listeners[evt_name811];return bb798._canvas.removeEventListener(evt_name811,cb812);};remove_listener810("mousemove");remove_listener810("mousedown");remove_listener810("mouseup");remove_listener810("mouseout");remove_listener810("mouseover");return remove_listener810("drag");},'invoke':function(world813, evt814) {var new_world815 = cb797(world813,evt814.x,evt814.y,evt814.evt);bb798.change_world(new_world815);return true;}};};};var on_key = function(cb816) {return function(bb817) {return {'name':"on-key",'register':function() {var canvas818 = bb817._canvas;this.listener = function(evt819) {evt819.preventDefault();evt819.stopPropagation();return bb817.queue_event({'type':"on-key",'key':key_event__gt_key_name(evt819)});};return canvas818.addEventListener("keydown",this.listener);},'deregister':function() {bb817._canvas.removeEventListener("keydown",this.listener);this.listener = undefined;return null;},'invoke':function(world820, evt821) {var new_world822 = cb816(world820,evt821.key);bb817.change_world(new_world822);return true;}};};};var stop_when4823 = function(last_world_p3824, last_picture1825, last_picture2826) {var last_world_p827 = last_world_p3824;if (last_picture2826) {var if_res1019 = last_picture1825;} else {var if_res1019 = false;}var last_picture828 = if_res1019;return function(bb829) {return {'name':"stop-when",'predicate':last_world_p827,'lastpicture':last_picture828,'register':function() {return bb829.add_world_change_listener(this.invoke);},'deregister':function() {return bb829.remove_world_change_listener(this.invoke);},'invoke':function(w830) {if (last_world_p827(w830)) {bb829.stop();if (last_picture828) {var handler831 = to_draw(last_picture828)(bb829);var if_res1020 = bb829.queue_event({'type':"raw",'invoke':handler831.invoke});} else {var if_res1020 = M0.rvoid();}var if_res1021 = if_res1020;} else {var if_res1021 = M0.rvoid();}return if_res1021;}};};};var stop_when = function() {var args1022 = $rjs_core.Pair.listFromArray($rjs_core.argumentsToArray(arguments));if (M0.equal_p(M0.length(args1022),1)) {var if_res1024 = M0.apply(function(last_world_p832) {return stop_when4823(last_world_p832,false,false);},args1022);} else {if (M0.equal_p(M0.length(args1022),2)) {var if_res1023 = M0.apply(function(last_world_p833, last_picture1834) {return stop_when4823(last_world_p833,last_picture1834,true);},args1022);} else {var if_res1023 = M0.error("case-lambda: invalid case");}var if_res1024 = if_res1023;}return if_res1024;};var _times_key_table_times_ = M0.hasheq(16,"shift",17,"controxl",19,"pause",27,"escape",33,"prior",34,"next",35,"end",36,"home",37,"left",38,"up",39,"right",40,"down",42,"print",45,"insert",106,"*",107,"+",109,"-",110,".",111,"/",144,"numlock",145,"scroll",186,";",187,"=",188,",",189,"-",190,".",191,"/",192,"`",219,"[",220,"\\",221,"]",22,"'");var key_event__gt_key_name = function(e835) {var or_part837 = e835.charCode;if (or_part837) {var if_res1025 = or_part837;} else {var if_res1025 = e835.keyCode;}var code836 = if_res1025;var or_part838 = M0.hash_ref(_times_key_table_times_,code836,false);if (or_part838) {var if_res1028 = or_part838;} else {if (M0._lt__eq_(96,code836,105)) {var if_res1027 = (code836-96).toString();} else {if (M0._lt__eq_(112,code836,123)) {var if_res1026 = M1._plus__plus_("f",(code836-111).toString());} else {var if_res1026 = String.fromCharCode(code836).toLowerCase();}var if_res1027 = if_res1026;}var if_res1028 = if_res1027;}return if_res1028;};var canvas_posn_δ = function(canvas839, evt840) {var rect841 = canvas839.getBoundingClientRect();return {'x':evt840.clientX-rect841.left,'y':evt840.clientY-rect841.top};};var key_eq__p = function(k1842, k2843) {return M0.equal_p(k1842,k2843);};export { on_mouse,on_tick,on_key,to_draw,stop_when,big_bang,key_eq__p };