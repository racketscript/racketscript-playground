import * as $rjs_core from '../../../../runtime/core.js';import * as M0 from "../../../../runtime/kernel.rkt.js";import * as M1 from "../private/jscommon.rkt.js";import * as M2 from "../../../racketscript-compiler/racketscript/interop.rkt.js";var _times_default_frames_per_second_times_ = 70;var make_big_bang = function(init_world662, handlers663) {return new BigBang(init_world662,handlers663);};var big_bang = function() {var init_world664 = arguments[0];var handlers665 = $rjs_core.Pair.listFromArray($rjs_core.argumentsSlice($rjs_core.argumentsToArray(arguments),1));return make_big_bang(init_world664,handlers665).setup().start();};var BigBang = function(init_world666, handlers667) {this.world = init_world666;this.interval = 1000/_times_default_frames_per_second_times_;this.handlers = handlers667;this._active_handlers = {};this._world_change_listeners = [];this._idle = true;this._stopped = true;this._events = [];return null;};BigBang.prototype.setup = function() {var canvas668 = M1.document.createElement("canvas");var ctx669 = canvas668.getContext("2d");canvas668.setAttribute("tabindex",1);var let_result184 = M0.values();this._canvas = canvas668;var let_result185 = M0.values();this._context = ctx669;var let_result186 = M0.values();M1.document.body.appendChild(canvas668);var let_result187 = M0.values();canvas668.focus();var let_result188 = M0.values();this.register_handlers();var let_result189 = M0.values();var draw_handler670 = this._active_handlers["to-draw"];if (draw_handler670) {var if_res190 = M0.rvoid();} else {var if_res190 = M0.error($rjs_core.Symbol.make("big-bang"),"to-draw handle not provided");}if_res190;var let_result191 = M0.values();var img671 = draw_handler670.callback(this.world);canvas668.width = img671.width;canvas668.height = img671.height;this.change_world(this.world);return this;};BigBang.prototype.register_handlers = function() {var active_handlers672 = this._active_handlers;var self673 = this;var loop674 = function(handlers675) {if (M0.pair_p(handlers675)) {var h676 = M0.car(handlers675)(self673);h676.register();active_handlers672[h676.name] = h676;var if_res192 = loop674(M0.cdr(handlers675));} else {var if_res192 = M0.rvoid();}return if_res192;};return loop674(this.handlers);};BigBang.prototype.deregister_handlers = function() {var active_handlers677 = this._active_handlers;var self678 = this;return Object.keys(active_handlers677).forEach(function(key679) {var h680 = active_handlers677[key679];h680.deregister();active_handlers677[h680.name] = undefined;return null;});};BigBang.prototype.start = function() {this._stopped = false;return this.process_events();};BigBang.prototype.stop = function() {this.clear_event_queue();this._stopped = true;this._idle = true;this.deregister_handlers();this._active_handlers = {};this.handlers = $rjs_core.Pair.Empty;return null;};BigBang.prototype.clear_event_queue = function() {return this._events.splice(0,this._events.length);};BigBang.prototype.queue_event = function(e681) {this._events.push(e681);if (this._idle) {var self682 = this;var if_res193 = window.requestAnimationFrame(function() {return self682.process_events();});} else {var if_res193 = M0.rvoid();}return if_res193;};BigBang.prototype.change_world = function(new_world683) {var listeners684 = this._world_change_listeners;var loop685 = function(i686) {if (M0._lt_(i686,listeners684.length)) {var listener687 = listeners684[i686];listener687(new_world683);var if_res194 = loop685(M0.add1(i686));} else {var if_res194 = M0.rvoid();}return if_res194;};loop685(0);this.world = new_world683;return null;};BigBang.prototype.add_world_change_listener = function(cb688) {return this._world_change_listeners.push(cb688);};BigBang.prototype.remove_world_change_listener = function(cb689) {var index690 = this._world_change_listeners.indexOf(cb689);return this._world_change_listeners.splice(index690,1);};BigBang.prototype.process_events = function() {var events691 = this._events;var self692 = this;this._idle = false;var loop693 = function(world_changed_p694) {if (M0._gt_(events691.length,0)) {var evt695 = events691.shift();var handler696 = self692._active_handlers[evt695.type];if (handler696) {var if_res196 = handler696.invoke(self692.world,evt695);} else {if (M0.equal_p(evt695.type,"raw")) {var if_res195 = evt695.invoke(self692.world,evt695);} else {var if_res195 = M1.console.warn("ignoring unknown/unregistered event type: ",evt695);}var if_res196 = if_res195;}var changed_p697 = if_res196;var or_part698 = world_changed_p694;if (or_part698) {var if_res197 = or_part698;} else {var if_res197 = changed_p697;}var if_res200 = loop693(if_res197);} else {if (world_changed_p694) {var if_res198 = M0.not(self692._stopped);} else {var if_res198 = false;}if (if_res198) {self692.queue_event({'type':"to-draw"});var if_res199 = loop693(false);} else {var if_res199 = M0.rvoid();}var if_res200 = if_res199;}return if_res200;};loop693(false);this._idle = true;return null;};var to_draw = function(cb699) {return function(bb700) {var on_tick_evt701 = {'type':"to-draw"};return {'name':"to-draw",'register':function() {return M0.rvoid();},'deregister':function() {return M0.rvoid();},'callback':cb699,'invoke':function(world702, evt703) {var ctx704 = bb700._context;var img705 = cb699(bb700.world);var height706 = img705.height;var width707 = img705.width;ctx704.clearRect(0,0,width707,height706);img705.render(ctx704,width707/2,height706/2);return false;}};};};var on_tick = function(cb708, rate709) {return function(bb710) {var on_tick_evt711 = {'type':"on-tick"};return {'name':"on-tick",'register':function() {bb710.queue_event(on_tick_evt711);if (rate709) {rate709 = 1000*rate709;var if_res201 = null;} else {rate709 = bb710.interval;var if_res201 = null;}return if_res201;},'deregister':function() {var last_cb712 = this.last_cb;if (last_cb712) {var if_res202 = window.clearTimeout(last_cb712);} else {var if_res202 = M0.rvoid();}return if_res202;},'invoke':function(world713, _714) {bb710.change_world(cb708(world713));this.last_cb = setTimeout(function() {return bb710.queue_event(on_tick_evt711);},rate709);return true;}};};};var on_mouse = function(cb715) {return function(bb716) {return {'name':"on-mouse",'listeners':{},'register':function() {var canvas717 = bb716._canvas;var make_listener718 = function(r_evt_name719) {return function(evt720) {var posn721 = canvas_posn_δ(canvas717,evt720);return bb716.queue_event({'type':"on-mouse",'evt':r_evt_name719,'x':posn721.x,'y':posn721.y});};};var self722 = this;var register_listener723 = function(evt_name724, r_evt_name725) {var cb726 = make_listener718(r_evt_name725);canvas717.addEventListener(evt_name724,cb726);self722.listeners[evt_name724] = cb726;return null;};register_listener723("mousemove","move");register_listener723("mousedown","button-down");register_listener723("mouseup","button-up");register_listener723("mouseout","leave");register_listener723("mouseover","enter");return register_listener723("drag","drag");},'deregister':function() {var self727 = this;var remove_listener728 = function(evt_name729) {var cb730 = self727.listeners[evt_name729];return bb716._canvas.removeEventListener(evt_name729,cb730);};remove_listener728("mousemove");remove_listener728("mousedown");remove_listener728("mouseup");remove_listener728("mouseout");remove_listener728("mouseover");return remove_listener728("drag");},'invoke':function(world731, evt732) {var new_world733 = cb715(world731,evt732.x,evt732.y,evt732.evt);bb716.change_world(new_world733);return true;}};};};var on_key = function(cb734) {return function(bb735) {return {'name':"on-key",'register':function() {var canvas736 = bb735._canvas;this.listener = function(evt737) {evt737.preventDefault();evt737.stopPropagation();return bb735.queue_event({'type':"on-key",'key':key_event__gt_key_name(evt737)});};return canvas736.addEventListener("keydown",this.listener);},'deregister':function() {bb735._canvas.removeEventListener("keydown",this.listener);this.listener = undefined;return null;},'invoke':function(world738, evt739) {var new_world740 = cb734(world738,evt739.key);bb735.change_world(new_world740);return true;}};};};var stop_when4741 = function(last_world_p3742, last_picture1743, last_picture2744) {var last_world_p745 = last_world_p3742;if (last_picture2744) {var if_res203 = last_picture1743;} else {var if_res203 = false;}var last_picture746 = if_res203;return function(bb747) {return {'name':"stop-when",'predicate':last_world_p745,'lastpicture':last_picture746,'register':function() {return bb747.add_world_change_listener(this.invoke);},'deregister':function() {return bb747.remove_world_change_listener(this.invoke);},'invoke':function(w748) {if (last_world_p745(w748)) {bb747.stop();if (last_picture746) {var handler749 = to_draw(last_picture746)(bb747);var if_res204 = bb747.queue_event({'type':"raw",'invoke':handler749.invoke});} else {var if_res204 = M0.rvoid();}var if_res205 = if_res204;} else {var if_res205 = M0.rvoid();}return if_res205;}};};};var stop_when = function() {var args206 = $rjs_core.Pair.listFromArray($rjs_core.argumentsToArray(arguments));if (M0.equal_p(M0.length(args206),1)) {var if_res208 = M0.apply(function(last_world_p750) {return stop_when4741(last_world_p750,false,false);},args206);} else {if (M0.equal_p(M0.length(args206),2)) {var if_res207 = M0.apply(function(last_world_p751, last_picture1752) {return stop_when4741(last_world_p751,last_picture1752,true);},args206);} else {var if_res207 = M0.error("case-lambda: invalid case");}var if_res208 = if_res207;}return if_res208;};var _times_key_table_times_ = M0.hasheq(16,"shift",17,"controxl",19,"pause",27,"escape",33,"prior",34,"next",35,"end",36,"home",37,"left",38,"up",39,"right",40,"down",42,"print",45,"insert",106,"*",107,"+",109,"-",110,".",111,"/",144,"numlock",145,"scroll",186,";",187,"=",188,",",189,"-",190,".",191,"/",192,"`",219,"[",220,"\\",221,"]",22,"'");var key_event__gt_key_name = function(e753) {var or_part755 = e753.charCode;if (or_part755) {var if_res209 = or_part755;} else {var if_res209 = e753.keyCode;}var code754 = if_res209;var or_part756 = M0.hash_ref(_times_key_table_times_,code754,false);if (or_part756) {var if_res212 = or_part756;} else {if (M0._lt__eq_(96,code754,105)) {var if_res211 = (code754-96).toString();} else {if (M0._lt__eq_(112,code754,123)) {var if_res210 = M1._plus__plus_("f",(code754-111).toString());} else {var if_res210 = String.fromCharCode(code754).toLowerCase();}var if_res211 = if_res210;}var if_res212 = if_res211;}return if_res212;};var canvas_posn_δ = function(canvas757, evt758) {var rect759 = canvas757.getBoundingClientRect();return {'x':evt758.clientX-rect759.left,'y':evt758.clientY-rect759.top};};var key_eq__p = function(k1760, k2761) {return M0.equal_p(k1760,k2761);};export { on_mouse,on_tick,on_key,to_draw,stop_when,big_bang,key_eq__p };