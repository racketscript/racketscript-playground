import * as $rjs_core from '../../../../runtime/core.js';import * as M0 from "../../../../runtime/kernel.rkt.js";import * as M1 from "../private/jscommon.rkt.js";import * as M2 from "../../../racketscript-compiler/racketscript/interop.rkt.js";var _times_default_frames_per_second_times_ = 70;var make_big_bang = function(init_world496, handlers497) {return new BigBang(init_world496,handlers497);};var big_bang = function() {var init_world498 = arguments[0];var handlers499 = $rjs_core.Pair.listFromArray($rjs_core.argumentsSlice($rjs_core.argumentsToArray(arguments),1));return make_big_bang(init_world498,handlers499).setup().start();};var BigBang = function(init_world500, handlers501) {this.world = init_world500;this.interval = 1000/_times_default_frames_per_second_times_;this.handlers = handlers501;this._activeHandlers = {};this._worldChangeListeners = [];this._idle = true;this._stopped = true;this._events = [];return null;};BigBang.prototype.setup = function() {var canvas502 = M1.document.createElement("canvas");var ctx503 = canvas502.getContext("2d");canvas502.setAttribute("tabindex",1);var let_result101 = M0.values();this._canvas = canvas502;var let_result102 = M0.values();this._context = ctx503;var let_result103 = M0.values();M1.document.body.appendChild(canvas502);var let_result104 = M0.values();canvas502.focus();var let_result105 = M0.values();this.registerHandlers();var let_result106 = M0.values();var draw_handler504 = this._activeHandlers["to-draw"];if (draw_handler504) {var if_res107 = M0.rvoid();} else {var if_res107 = M0.error($rjs_core.Symbol.make("big-bang"),"to-draw handle not provided");}if_res107;var let_result108 = M0.values();var img505 = draw_handler504.callback(this.world);canvas502.width = img505.width;canvas502.height = img505.height;this.changeWorld(this.world);return this;};BigBang.prototype.registerHandlers = function() {var activeHandlers506 = this._activeHandlers;var self507 = this;var loop508 = function(handlers509) {if (M0.pair_p(handlers509)) {var h510 = M0.car(handlers509)(self507);h510.register();activeHandlers506[h510.name] = h510;var if_res109 = loop508(M0.cdr(handlers509));} else {var if_res109 = M0.rvoid();}return if_res109;};return loop508(this.handlers);};BigBang.prototype.deregisterHandlers = function() {var activeHandlers511 = this._activeHandlers;var self512 = this;return Object.keys(activeHandlers511).forEach(function(key513) {var h514 = activeHandlers511[key513];h514.deregister();activeHandlers511[h514.name] = undefined;return null;});};BigBang.prototype.start = function() {this._stopped = false;return this.processEvents();};BigBang.prototype.stop = function() {this.clearEventQueue();this._stopped = true;this._idle = true;this.deregisterHandlers();this._activeHandlers = {};this.handlers = $rjs_core.Pair.Empty;return null;};BigBang.prototype.clearEventQueue = function() {return this._events.splice(0,this._events.length);};BigBang.prototype.queueEvent = function(e515) {this._events.push(e515);if (this._idle) {var self516 = this;var if_res110 = window.requestAnimationFrame(function() {return self516.processEvents();});} else {var if_res110 = M0.rvoid();}return if_res110;};BigBang.prototype.changeWorld = function(new_world517) {var listeners518 = this._worldChangeListeners;var loop519 = function(i520) {if (M0._lt_(i520,listeners518.length)) {var listener521 = listeners518[i520];listener521(new_world517);var if_res111 = loop519(M0.add1(i520));} else {var if_res111 = M0.rvoid();}return if_res111;};loop519(0);this.world = new_world517;return null;};BigBang.prototype.addWorldChangeListener = function(cb522) {return this._worldChangeListeners.push(cb522);};BigBang.prototype.removeWorldChangeListener = function(cb523) {var index524 = this._worldChangeListeners.indexOf(cb523);return this._worldChangeListeners.splice(index524,1);};BigBang.prototype.processEvents = function() {var events525 = this._events;var self526 = this;this._idle = false;var loop527 = function(world_changed_p528) {if (M0._gt_(events525.length,0)) {var evt529 = events525.shift();var handler530 = self526._activeHandlers[evt529.type];if (handler530) {var if_res113 = handler530.invoke(self526.world,evt529);} else {if (M0.equal_p(evt529.type,"raw")) {var if_res112 = evt529.invoke(self526.world,evt529);} else {var if_res112 = M1.console.warn("ignoring unknown/unregistered event type: ",evt529);}var if_res113 = if_res112;}var changed_p531 = if_res113;var or_part532 = world_changed_p528;if (or_part532) {var if_res114 = or_part532;} else {var if_res114 = changed_p531;}var if_res117 = loop527(if_res114);} else {if (world_changed_p528) {var if_res115 = M0.not(self526._stopped);} else {var if_res115 = false;}if (if_res115) {self526.queueEvent({'type':"to-draw"});var if_res116 = loop527(false);} else {var if_res116 = M0.rvoid();}var if_res117 = if_res116;}return if_res117;};loop527(false);this._idle = true;return null;};var to_draw = function(cb533) {return function(bb534) {var on_tick_evt535 = {'type':"to-draw"};return {'name':"to-draw",'register':function() {return M0.rvoid();},'deregister':function() {return M0.rvoid();},'callback':cb533,'invoke':function(world536, evt537) {var ctx538 = bb534._context;var img539 = cb533(bb534.world);var height540 = img539.height;var width541 = img539.width;ctx538.clearRect(0,0,width541,height540);img539.render(ctx538,width541/2,height540/2);return false;}};};};var on_tick = function(cb542, rate543) {return function(bb544) {var on_tick_evt545 = {'type':"on-tick"};return {'name':"on-tick",'register':function() {bb544.queueEvent(on_tick_evt545);if (rate543) {rate543 = 1000*rate543;var if_res118 = null;} else {rate543 = bb544.interval;var if_res118 = null;}return if_res118;},'deregister':function() {var lastcb546 = this.lastcb;if (lastcb546) {var if_res119 = window.clearTimeout(lastcb546);} else {var if_res119 = M0.rvoid();}return if_res119;},'invoke':function(world547, _548) {bb544.changeWorld(cb542(world547));this.lastcb = setTimeout(function() {return bb544.queueEvent(on_tick_evt545);},rate543);return true;}};};};var on_mouse = function(cb549) {return function(bb550) {return {'name':"on-mouse",'listeners':{},'register':function() {var canvas551 = bb550._canvas;var make_listener552 = function(r_evt_name553) {return function(evt554) {var posn555 = canvas_posn_δ(canvas551,evt554);return bb550.queueEvent({'type':"on-mouse",'evt':r_evt_name553,'x':posn555.x,'y':posn555.y});};};var self556 = this;var register_listener557 = function(evt_name558, r_evt_name559) {var cb560 = make_listener552(r_evt_name559);canvas551.addEventListener(evt_name558,cb560);self556.listeners[evt_name558] = cb560;return null;};register_listener557("mousemove","move");register_listener557("mousedown","button-down");register_listener557("mouseup","button-up");register_listener557("mouseout","leave");register_listener557("mouseover","enter");return register_listener557("drag","drag");},'deregister':function() {var self561 = this;var remove_listener562 = function(evt_name563) {var cb564 = self561.listeners[evt_name563];return bb550._canvas.removeEventListener(evt_name563,cb564);};remove_listener562("mousemove");remove_listener562("mousedown");remove_listener562("mouseup");remove_listener562("mouseout");remove_listener562("mouseover");return remove_listener562("drag");},'invoke':function(world565, evt566) {var new_world567 = cb549(world565,evt566.x,evt566.y,evt566.evt);bb550.changeWorld(new_world567);return true;}};};};var on_key = function(cb568) {return function(bb569) {return {'name':"on-key",'register':function() {var canvas570 = bb569._canvas;this.listener = function(evt571) {evt571.preventDefault();evt571.stopPropagation();return bb569.queueEvent({'type':"on-key",'key':key_event__gt_key_name(evt571)});};return canvas570.addEventListener("keydown",this.listener);},'deregister':function() {bb569._canvas.removeEventListener("keydown",this.listener);this.listener = undefined;return null;},'invoke':function(world572, evt573) {var new_world574 = cb568(world572,evt573.key);bb569.changeWorld(new_world574);return true;}};};};var stop_when4575 = function(last_world_p3576, last_picture1577, last_picture2578) {var last_world_p579 = last_world_p3576;if (last_picture2578) {var if_res120 = last_picture1577;} else {var if_res120 = false;}var last_picture580 = if_res120;return function(bb581) {return {'name':"stop-when",'predicate':last_world_p579,'lastpicture':last_picture580,'register':function() {return bb581.addWorldChangeListener(this.invoke);},'deregister':function() {return bb581.removeWorldChangeListener(this.invoke);},'invoke':function(w582) {if (last_world_p579(w582)) {bb581.stop();if (last_picture580) {var handler583 = to_draw(last_picture580)(bb581);var if_res121 = bb581.queueEvent({'type':"raw",'invoke':handler583.invoke});} else {var if_res121 = M0.rvoid();}var if_res122 = if_res121;} else {var if_res122 = M0.rvoid();}return if_res122;}};};};var stop_when = function() {var args123 = $rjs_core.Pair.listFromArray($rjs_core.argumentsToArray(arguments));if (M0.equal_p(M0.length(args123),1)) {var if_res125 = M0.apply(function(last_world_p584) {return stop_when4575(last_world_p584,false,false);},args123);} else {if (M0.equal_p(M0.length(args123),2)) {var if_res124 = M0.apply(function(last_world_p585, last_picture1586) {return stop_when4575(last_world_p585,last_picture1586,true);},args123);} else {var if_res124 = M0.error("case-lambda: invalid case");}var if_res125 = if_res124;}return if_res125;};var _times_key_table_times_ = M0.hasheq(16,"shift",17,"controxl",19,"pause",27,"escape",33,"prior",34,"next",35,"end",36,"home",37,"left",38,"up",39,"right",40,"down",42,"print",45,"insert",106,"*",107,"+",109,"-",110,".",111,"/",144,"numlock",145,"scroll",186,";",187,"=",188,",",189,"-",190,".",191,"/",192,"`",219,"[",220,"\\",221,"]",22,"'");var key_event__gt_key_name = function(e587) {var or_part589 = e587.charCode;if (or_part589) {var if_res126 = or_part589;} else {var if_res126 = e587.keyCode;}var code588 = if_res126;var or_part590 = M0.hash_ref(_times_key_table_times_,code588,false);if (or_part590) {var if_res129 = or_part590;} else {if (M0._lt__eq_(96,code588,105)) {var if_res128 = (code588-96).toString();} else {if (M0._lt__eq_(112,code588,123)) {var if_res127 = M1._plus__plus_("f",(code588-111).toString());} else {var if_res127 = String.fromCharCode(code588).toLowerCase();}var if_res128 = if_res127;}var if_res129 = if_res128;}return if_res129;};var canvas_posn_δ = function(canvas591, evt592) {var rect593 = canvas591.getBoundingClientRect();return {'x':evt592.clientX-rect593.left,'y':evt592.clientY-rect593.top};};var key_eq__p = function(k1594, k2595) {return M0.equal_p(k1594,k2595);};export { on_mouse,on_tick,on_key,to_draw,stop_when,big_bang,key_eq__p };